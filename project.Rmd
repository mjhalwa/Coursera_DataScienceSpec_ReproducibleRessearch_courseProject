---
title: Detecting most
author: "Martin Halwachs"
date: "31 Juli 2016"
output:
  html_document:
    toc: TRUE
---

# Synopsis
**Ten sentences summarizing the result.**

# Used R Libraries
```{r loading libraries, results="hide", message=FALSE}
library(dplyr)
library(stringr)
```

# Data Processing
First the data is loaded from the web using a temporary file. Note that *.bz2 files can be read directly without unzipping.
```{r download data, cache=TRUE}
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
tempFile <- tempfile()
download.file(fileUrl, tempFile)
data <- read.csv(tempFile) #bz2 can be read directly without unzipping
```

# Tidy Data
The dimension and column headers of the imported data are:
```{r show all column names}
dim(data)
names(data)
```

To reduce memory overhead less important columns are removed
```{r less columns}
data <- select(data, c(BGN_DATE,EVTYPE,END_DATE,FATALITIES:CROPDMGEXP))
```

## Explanation of relevant colum headers
The [documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) does not show the column header names. Therefore the following list shall provide necessary information about the column names. The section in the documentation is statet, if any information on this column was found. 

(@) **BGN_DATE** - begin date of event (not explicitly stated in the documentation)  
These dates are formated properly, while ignoring the included timestamp:
```{r formating begin date}
dateformat <- "%m/%d/%Y"
data$BGN_DATE <- as.Date(data$BGN_DATE, dateformat)
```

(@) **END_DATE** - end date of event (not explicitly stated in the documentation)  
These dates are formated properly, while ignoring the included timestamp (see BGN_DATE for the date format):
```{r formating end date}
data$END_DATE <- as.Date(data$END_DATE, dateformat)
```

(@) **FATALITIES** - number of fatalities

(@) **INJURIES** - number of injured humans

(@) **PROPDMG** - Property damage in actual dollar amount
According to Chapter 2.7: "*Property damage estimates should be entered as actual dollar amounts, if a reasonably accurate estimate from an insurance company or other qualified individual is available.* [...] *Typically, damage refers to damage inflicted to private property (structures, objects, vegetation) as well as public infrastructure and facilities. Specific breakdowns should be stated in the event narrative (refer to Section 2.9), if possible. The number of structures with minor or moderate damage should be indicated, as well as the number of buildings destroyed.* [...]"

(@) **PROPDMGEXP** - Property damage exponent  
Various property damages can be looked up in Appendix B. According to Chapter 2.7: "[...]*"Estimates should be rounded to three significant digits, followed by an alphabetical character signifying the magnitude of the number, i.e., 1.55B for $1,550,000,000. Alphabetical characters used to signify magnitude include 'K' for thousands, 'M' for millions, and 'B' for billions.*[...]", this column provides information on the exponent for the property damage value. The following shows the found indicators with their count:
```{r property damage exponents}
table(data$PROPDMGEXP)
```
**Important notice:** As only 'K', 'M' and 'B' were cited and the empty string seems to stand for no exponent, all others will be neglected, treating them as improper entries (though 'h' or 'H' may stand for hundreds). As 'milli' for 'm' makes no sense and 'k' for 'kilo' was already stated as 'K' above, the three letters will be tretated case-insensitive!
The following table sums up the treatment of this column:  

| indicator | property.damage |
|-----------|-----------------|
| k,K       | PROPDMG\*10E3   |
| m,M       | PROPDMG\*10E6   |
| b,B       | PROPDMB\*10E9   |

The property damage is adjusted according to the above exponents. Finally this column is dismissed from further evaulations.
```{r get accurate property damage}
columns <- data$PROPDMGEXP %in% c("k","K")
with(data, PROPDMG[columns] <- PROPDMG[columns]*1E3)

columns <- data$PROPDMGEXP %in% c("m","M")
with(data, PROPDMG[columns] <- PROPDMG[columns]*1E6)

columns <- data$PROPDMGEXP %in% c("b","B")
with (data, PROPDMG[columns] <- PROPDMG[columns]*1E9)

columns <- !(data$PROPDMGEXP %in% c("","k","K","m","M","b","B"))
data$PROPDMG[columns] <- 0
data <- select(data, -PROPDMGEXP)
```

(@) **CROPDMG** - Crop damage (not further )  
According to Appendix B: "[...]*Crop damage [Crop value/acre]x [#acres]*[...]"

(@) **CROPDMGEXP** - Crop damage exponent  
seems to be the same as the PROPDMGEXP. The following shows the various indicators and their count:
```{r crop damage exponents}
table(data$CROPDMGEXP)
```

In accordance with PROPDMGEXP, the exponents are applied. The costs for crop and property damage are summed and the separate columns are dismissed from further evaluations. 
```{r get accurate crop damage}
columns <- data$CROPDMGEXP %in% c("k","K")
with(data, CROPDMG[columns] <- CROPDMG[columns]*1E3)

columns <- data$CROPDMGEXP %in% c("m","M")
with(data, CROPDMG[columns] <- CROPDMG[columns]*1E6)

columns <- data$CROPDMGEXP %in% c("b","B")
with (data, CROPDMG[columns] <- CROPDMG[columns]*1E9)

columns <- !(data$CROPDMGEXP %in% c("","k","K","m","M","b","B"))
data$CROPDMG[columns] <- 0

data <- mutate(data, COSTS=CROPDMG+PROPDMG)
data <- select(data, -c(PROPDMG, CROPDMG, CROPDMGEXP))
```

(@) **EVTYPE** - Envent type  
Chapter 2.1.1 Table 1, lists several types of Storm Data events. The following list shows some sample of the `r length(unique(data$EVTYPE))` unique raw imported event types
```{r show data events}
set.seed(123)
sort(sample(unique(data$EVTYPE),60))
```

This small selection already shows that the list has several errors (e.g. 'Strong wind' and 'Strong Winds'), includes several summaries and could be reduced to a more compact list of several events.

First all elements are written lower case, which already solves some issues, next the summaries are removed,
```{r lower case and remove summaries}
head(sort(unique(data$EVTYPE)),30)
data$EVTYPE <- as.factor(str_to_lower(data$EVTYPE))
head(sort(unique(data$EVTYPE)),30)

summarydata <- grepl("summary", data$EVTYPE)
unique(data$EVTYPE[summarydata])
data <- data[!summarydata,]
```
This step already reduced the list to `r length(unique(data$EVTYPE))` unique types.

Next the steps is removing multiple spaces and wrong signes:
```{r eliminate sign and whitespace errors}
head(sort(unique(data$EVTYPE)),10)
#unique(data$EVTYPE[grepl("^tstm",data$EVTYPE)])
data$EVTYPE <- as.factor(gsub("^[ ]+","",data$EVTYPE)) #whitespace at begin
data$EVTYPE <- as.factor(gsub("[ ]+$","",data$EVTYPE)) #whitespace at end
data$EVTYPE <- as.factor(gsub("[ ]{2,}"," ",data$EVTYPE)) #(multiple whitespaces)

data$EVTYPE <- as.factor(gsub("[\\&;-]{1,3}","/",data$EVTYPE)) #signs instead of slash
data$EVTYPE <- as.factor(gsub(" /","/",data$EVTYPE)) #whitespace before slash
data$EVTYPE <- as.factor(gsub("/ ","/",data$EVTYPE)) #whitespace after slash

data$EVTYPE <- as.factor(gsub("[\\./]([ ]){0,10}$","",data$EVTYPE)) #signs at string end

head(sort(unique(data$EVTYPE)),30)
```

Finally the various event types are reduced to a rough grouping.
```{r reduce event types}
data$EVTYPE <- as.factor(gsub("^aval.*","avalanche",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^blizzard[ /$].*","blizzard",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^blow.*snow.*","blizzard",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^(co?a?sta?l|beach).*","coastal flood",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^(cold|cool).*","cold/wind chill",data$EVTYPE))
data$EVTYPE <- as.factor(gsub(".*wind ?chill.*","cold/wind chill",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^(dry|wet) mi[cr]+oburst.*","thunderstorm wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^dust dev[ie]l.*","dust devil",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^dust ?storm.*","dust storm",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^dr[yo]u?g?h?t?.*","drought",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^(ex(cess|trem)|record|un(usual|season)|very).*(dry|heat|warm|hot).*","drought",data$EVTYPE))

data$EVTYPE <- as.factor(gsub("^(flash|flood).*(flood|flash).*","flash flood",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^flood.*","flood",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^drowning","flood",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^drowburst","thunderstorm wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^gust(nado|y).*","thunderstorm wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^hail[ /$].*","hail",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^heavy.*snow.*","heavy snow",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^he?a?vy.*rain.*","heavy rain",data$EVTYPE))
data$EVTYPE <- as.factor(gsub(".*surf.*","high surf",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^high.*wind.*","high wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^hurri.*","hurricane (typhoon)",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^ice.*","ice storm",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^lig[hn]tn?ing.*","lightning",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^snow.*","heavy snow",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^th?un?d?er?.*","thunderstorm wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^tropical storm.*","tropical strom",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^tstm.*","thunderstorm wind",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^volc.*","volcanic ash",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^torn[ad]+o.*","tornado",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^typhoon.*","hurricane (typhoon)",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^urban.*","flood",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^forest.*","wildfire",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^brush.*","wildfire",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^warm","drought",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^way?ter ?spout.*","waterspout",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^wild.*","wildfire",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^winter storm.*","winter storm",data$EVTYPE))
data$EVTYPE <- as.factor(gsub("^wint[ery ]+(weather|mix).*","winter weather",data$EVTYPE))



#data$EVTYPE <- as.factor(gsub("^hail *","hail",data$EVTYPE))
#data$EVTYPE <- as.factor(gsub("^hail *","hail",data$EVTYPE))

#data$EVTYPE <- as.factor(gsub("[()]","",data$EVTYPE)) #signs instead of slash
```

This brings up the final list of event types, beeing `r length(unique(data$EVTYPE))` different entries:
```{r final event type list}
sort(unique(data$EVTYPE))
```

## Checking Data
The data import is then checked in  
(@) dimension,
```{r check data dim}
dim(data)
```

(@) first and last lines,
```{r check data lines}
head(data)
tail(data)
```

(@) and data structure in R.
```{r check data structure}
str(data)
```

```{r check columns}
unique(data$F)
unique(data$MAG)
```

# Results
The follwing chapters will evaluated the consequences of the `r length(levels(data$EVTYPE))` events listed below:
```{r list events}
#table(data$EVTYPE)
```


## 